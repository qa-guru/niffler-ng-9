name: e2e

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  e2e:
    runs-on: ubuntu-latest
    env:
      PROFILE: docker
      PREFIX: qaguru
      COMPOSE_PROFILES: test
      ARCH: amd64
      ALLURE_DOCKER_API: ${{ secrets.ALLURE_DOCKER_API }}
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      BUILD_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
      EXECUTION_TYPE: github
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      - name: Build backends
        id: build
        run: |
          ./gradlew jibDockerBuild -x :niffler-e-2-e-tests:test -Duser.timezone=UTC
      - name: Report test results
        uses: dorny/test-reporter@v2
        if: always() && steps.build.outcome != 'skipped'
        with:
          name: Unit & Integration tests
          path: '**/build/test-results/test/TEST-*.xml'
          reporter: java-junit
          badge-title: 'unit & integration tests'
      - name: Add comment to PR with link to unit tests results
        if: always() && steps.build.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ steps.build.outcome }}'
            const message = buildStatus === 'success'
              ? `âœ… UNIT & INTEGRATION TESTS PASSED`
              : `ðŸ”´ UNIT & INTEGRATION TESTS FAILED`

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
      - name: Pull Chrome 135
        run: |
          docker pull twilio/selenoid:chrome_stable_135
      - name: Get the last commit message
        run: |
          echo "HEAD_COMMIT_MESSAGE=$(git log -1 --format=%s ${{ github.event.pull_request.head.sha }})" >> $GITHUB_ENV
      - name: Prepare screenshot dir
        run: |
          mkdir -p niffler-e-2-e-tests/.screen-output/screenshots/selenoid
      - name: Prepare logs dir
        run: |
          mkdir -p logs/niffler-auth logs/niffler-currency logs/niffler-gateway logs/niffler-spend logs/niffler-userdata
      - name: Run tests
        id: run-tests
        run: |
          docker compose up -d
          docker ps -a
          docker wait niffler-e-2-e
          exit_code=$(docker inspect -f '{{.State.ExitCode}}' niffler-e-2-e)
          echo "E2E_EXIT_CODE=$exit_code" >> $GITHUB_OUTPUT
          echo "### Test logs ###"
          docker logs niffler-e-2-e
          if [ "$exit_code" -eq "0" ]; then
            echo "Tests passed successfully!"
            exit 0
          else
            echo "Tests failed!"
            exit 1
          fi
      - name: Upload screenshots artifact
        if: always() && steps.run-tests.outcome != 'skipped'
        uses: actions/upload-artifact@v4
        with:
          name: e2e-screenshots-${{ github.run_id }}
          path: |
            niffler-e-2-e-tests/.screen-output/screenshots/selenoid/**/*.png
          if-no-files-found: warn
          retention-days: 14
      - name: Add comment to PR with link to allure
        if: always() && steps.run-tests.outcome != 'skipped'
        uses: actions/github-script@v7
        with:
          script: |
            const exitCode = ${{ steps.run-tests.outputs.E2E_EXIT_CODE }}
            const reportUrl = 'https://allure.niffler-stage.qa.guru/api/allure-docker-service/projects/niffler-ng-9/reports/latest/index.html'
            const historyUrl = 'https://allure.niffler-stage.qa.guru/allure-docker-service-ui/projects/niffler-ng-9'
            const message = exitCode == '0' ?
              `âœ… E2E TESTS PASSED\nThere is the [report](${reportUrl})\nAll reports [history](${historyUrl})` :
              `ðŸ”´ E2E TESTS FAILED\nThere is the [report](${reportUrl})\nAll reports [history](${historyUrl})`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })
          
      





